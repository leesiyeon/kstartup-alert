name: ğŸš€ K-startup Alert Scheduler

on:
  schedule:
    # ë§¤ì‹œê°„ ì •ê°ì— ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '0 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  check-announcements:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” K-startup ê³µê³  í™•ì¸
      run: |
        echo "ğŸš€ K-startup ê³µê³  í™•ì¸ ì‹œì‘..."
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"
        
        # í™˜ê²½ë³€ìˆ˜ í™•ì¸
        if [ -z "${{ secrets.VERCEL_APP_URL }}" ]; then
          echo "âŒ ì˜¤ë¥˜: VERCEL_APP_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "ğŸ“‹ ì„¤ì • ë°©ë²•:"
          echo "1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
          echo "2. 'New repository secret' í´ë¦­"
          echo "3. Name: VERCEL_APP_URL"
          echo "4. Value: https://your-app.vercel.app (ì‹¤ì œ Vercel ë°°í¬ URL)"
          exit 1
        fi
        
        # Vercel ë°°í¬ëœ API í˜¸ì¶œ
        echo "ğŸ“¡ API í˜¸ì¶œ ì¤‘: ${{ secrets.VERCEL_APP_URL }}/api/notifications/check"
        
        response=$(curl -s -X POST "${{ secrets.VERCEL_APP_URL }}/api/notifications/check" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-KStartup-Alert/1.0" \
          -w "%{http_code}" \
          --max-time 30 \
          --retry 3 \
          --retry-delay 5)
        
        http_code="${response: -3}"
        body="${response%???}"
        
        echo "ğŸ“Š HTTP Status: $http_code"
        echo "ğŸ“„ Response Body: $body"
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… K-startup ê³µê³  í™•ì¸ ì„±ê³µ!"
          
          # JSON íŒŒì‹±í•´ì„œ ê²°ê³¼ ì¶œë ¥
          new_count=$(echo "$body" | grep -o '"newAnnouncements":[0-9]*' | cut -d':' -f2 || echo "0")
          total_count=$(echo "$body" | grep -o '"totalAnnouncements":[0-9]*' | cut -d':' -f2 || echo "0")
          ongoing_count=$(echo "$body" | grep -o '"ongoingAnnouncements":[0-9]*' | cut -d':' -f2 || echo "0")
          
          echo "ğŸ“ˆ ì´ ê³µê³ : $total_countê°œ"
          echo "ğŸ”„ ì§„í–‰ì¤‘: $ongoing_countê°œ" 
          echo "ğŸ†• ìƒˆ ê³µê³ : $new_countê°œ"
          
          if [ "$new_count" -gt "0" ]; then
            echo "ğŸ‰ ìƒˆë¡œìš´ ê³µê³  $new_countê°œ ì•Œë¦¼ ì „ì†¡ë¨!"
          else
            echo "ğŸ’¤ ìƒˆë¡œìš´ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
        else
          echo "âŒ K-startup ê³µê³  í™•ì¸ ì‹¤íŒ¨ (HTTP $http_code)"
          echo "ğŸ” ì‘ë‹µ ë‚´ìš©: $body"
          exit 1
        fi
        
        echo "âœ¨ K-startup ê³µê³  í™•ì¸ ì™„ë£Œ!"

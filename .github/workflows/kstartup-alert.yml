name: ğŸš€ K-startup Alert Scheduler

on:
  schedule:
    # ë§¤ì‹œê°„ ì •ê°ì— ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '0 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  check-announcements:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” K-startup ê³µê³  í™•ì¸
      run: |
        echo "ğŸš€ K-startup ê³µê³  í™•ì¸ ì‹œì‘..."
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"
        
        # í™˜ê²½ë³€ìˆ˜ í™•ì¸
        if [ -z "${{ secrets.VERCEL_APP_URL }}" ]; then
          echo "âŒ ì˜¤ë¥˜: VERCEL_APP_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "ğŸ“‹ ì„¤ì • ë°©ë²•:"
          echo "1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
          echo "2. 'New repository secret' í´ë¦­"
          echo "3. Name: VERCEL_APP_URL"
          echo "4. Value: https://your-app.vercel.app (ì‹¤ì œ Vercel ë°°í¬ URL)"
          exit 1
        fi
        
        # URL ì •ê·œí™” (ëì— ìŠ¬ë˜ì‹œ ì œê±°)
        NORMALIZED_URL=$(echo "${{ secrets.VERCEL_APP_URL }}" | sed 's/\/*$//')
        API_ENDPOINT="${NORMALIZED_URL}/api/notifications/check"
        
        echo "ğŸ“¡ API í˜¸ì¶œ ì¤‘: $API_ENDPOINT"
        echo "ğŸ” ë””ë²„ê·¸ ì •ë³´:"
        echo "  - ì›ë³¸ URL: ${{ secrets.VERCEL_APP_URL }}"
        echo "  - ì •ê·œí™”ëœ URL: $NORMALIZED_URL"
        echo "  - ìµœì¢… API ì—”ë“œí¬ì¸íŠ¸: $API_ENDPOINT"
        echo "  - ìš”ì²­ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # Vercel ë°°í¬ëœ API í˜¸ì¶œ (ë¦¬ë””ë ‰ì…˜ ìë™ ë”°ë¼ê°€ê¸°)
        echo "â³ curl ìš”ì²­ ì‹¤í–‰ ì¤‘..."
        response=$(curl -s -L -X POST "$API_ENDPOINT" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-KStartup-Alert/1.0" \
          -H "Accept: application/json" \
          -w "%{http_code}|%{redirect_url}|%{num_redirects}|%{time_total}" \
          --max-time 30 \
          --retry 3 \
          --retry-delay 5 \
          --connect-timeout 10)
        
        # ì‘ë‹µ íŒŒì‹± (í˜•ì‹: body|http_code|redirect_url|num_redirects|time_total)
        IFS='|' read -r body http_code redirect_url num_redirects time_total <<< "$response"
        
        echo "ğŸ“Š ì‘ë‹µ ì •ë³´:"
        echo "  - HTTP Status: $http_code"
        echo "  - ì‘ë‹µ ì‹œê°„: ${time_total}ì´ˆ"
        echo "  - Response Body: $body"
        
        # ë¦¬ë””ë ‰ì…˜ ì •ë³´ ì¶œë ¥
        if [ "$num_redirects" -gt "0" ]; then
          echo "ğŸ”„ ë¦¬ë””ë ‰ì…˜ ë°œìƒ:"
          echo "  - ë¦¬ë””ë ‰ì…˜ íšŸìˆ˜: $num_redirectsë²ˆ"
          echo "  - ìµœì¢… URL: $redirect_url"
        fi
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… K-startup ê³µê³  í™•ì¸ ì„±ê³µ!"
          
          # JSON íŒŒì‹±í•´ì„œ ê²°ê³¼ ì¶œë ¥
          new_count=$(echo "$body" | grep -o '"newAnnouncements":[0-9]*' | cut -d':' -f2 || echo "0")
          total_count=$(echo "$body" | grep -o '"totalAnnouncements":[0-9]*' | cut -d':' -f2 || echo "0")
          ongoing_count=$(echo "$body" | grep -o '"ongoingAnnouncements":[0-9]*' | cut -d':' -f2 || echo "0")
          
          echo "ğŸ“ˆ ì´ ê³µê³ : $total_countê°œ"
          echo "ğŸ”„ ì§„í–‰ì¤‘: $ongoing_countê°œ" 
          echo "ğŸ†• ìƒˆ ê³µê³ : $new_countê°œ"
          
          if [ "$new_count" -gt "0" ]; then
            echo "ğŸ‰ ìƒˆë¡œìš´ ê³µê³  $new_countê°œ ì•Œë¦¼ ì „ì†¡ë¨!"
          else
            echo "ğŸ’¤ ìƒˆë¡œìš´ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
        else
          echo "âŒ K-startup ê³µê³  í™•ì¸ ì‹¤íŒ¨ (HTTP $http_code)"
          echo "ğŸ” ì‘ë‹µ ë‚´ìš©: $body"
          
          # ì¼ë°˜ì ì¸ HTTP ìƒíƒœ ì½”ë“œ ì„¤ëª…
          case "$http_code" in
            "308") echo "ğŸ’¡ HTTP 308: ì˜êµ¬ ë¦¬ë””ë ‰ì…˜ - URLì´ ë‹¤ë¥¸ ì£¼ì†Œë¡œ ì´ë™ë¨" ;;
            "301") echo "ğŸ’¡ HTTP 301: ì˜êµ¬ ì´ë™ - ìƒˆë¡œìš´ URLë¡œ ì ‘ì† í•„ìš”" ;;
            "302") echo "ğŸ’¡ HTTP 302: ì„ì‹œ ë¦¬ë””ë ‰ì…˜" ;;
            "404") echo "ğŸ’¡ HTTP 404: API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ" ;;
            "500") echo "ğŸ’¡ HTTP 500: ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜" ;;
            "502") echo "ğŸ’¡ HTTP 502: ê²Œì´íŠ¸ì›¨ì´ ì˜¤ë¥˜ - Vercel ë°°í¬ ìƒíƒœ í™•ì¸ í•„ìš”" ;;
            "503") echo "ğŸ’¡ HTTP 503: ì„œë¹„ìŠ¤ ì‚¬ìš© ë¶ˆê°€ - ì¼ì‹œì  ì„œë²„ ë¬¸ì œ" ;;
            "000") echo "ğŸ’¡ HTTP 000: ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ" ;;
          esac
          
          echo ""
          echo "ğŸ› ï¸  ë¬¸ì œ í•´ê²° ë°©ë²•:"
          echo "1. VERCEL_APP_URLì´ ì˜¬ë°”ë¥¸ Vercel ë°°í¬ URLì¸ì§€ í™•ì¸"
          echo "2. Vercel ëŒ€ì‹œë³´ë“œì—ì„œ ë°°í¬ ìƒíƒœ í™•ì¸"
          echo "3. API ì—”ë“œí¬ì¸íŠ¸ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸"
          echo "4. í™˜ê²½ë³€ìˆ˜ì— https:// í”„ë¡œí† ì½œì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸"
          
          exit 1
        fi
        
        echo "âœ¨ K-startup ê³µê³  í™•ì¸ ì™„ë£Œ!"
